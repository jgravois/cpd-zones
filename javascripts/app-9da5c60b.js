function score_compare(e,a){return e.score<a.score?-1:e.score>a.score?1:0}function render_template(e,a){var t=Mustache.render(e,a);$(".zone-results").append(t)}function flash_message(e,a){return"<div class='flash-"+e+"'><span>"+a+"</span></div>"}function build_query(e){return{"Single Line Input":e,f:"json",outSR:4326}}var southWest=L.latLng(34.9816,-85.4719),northEast=L.latLng(35.217,-85.0462),center=L.latLng(35.0657,-85.241),bounds=L.latLngBounds(southWest,northEast),tiles="//otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png",geocoder="http://maps.hamiltontn.gov/ArcGIS/rest/services/Addressing_Locator/GeocodeServer/findAddressCandidates",card_template=$("#card_template").html(),zone_name_template=$("#zone_name_template").html(),map_attribution='Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Zone data &copy; City of Chattanooga',marker,zones;L.Icon.Default.imagePath="images/leaflet-img";var map=L.map("map",{maxZoom:18,minZoom:11,maxBounds:bounds,center:center,zoom:12});L.tileLayer(tiles,{attribution:map_attribution}).addTo(map),omnivore.topojson("data/CPDZones.topojson").on("ready",function(){zones=this,this.eachLayer(function(e){e.setStyle(e.feature.properties)}),$("#input_form").submit(function(e){e.preventDefault(),void 0!==marker&&map.removeLayer(marker);var a=$("#query").val();$(".zone-results").html(""),$("#flash").html(""),$.ajax({url:geocoder,jsonp:"callback",dataType:"jsonp",timeout:5e3,data:build_query(a),success:function(e){if(e.candidates.length>0){var a=e.candidates.sort(score_compare)[e.candidates.length-1].location,t=L.latLng(a.y,a.x),r=leafletPip.pointInLayer(t,zones);if(r.length>0){var o=r[0],n=o.feature.properties;marker=new L.Marker(t),map.addLayer(marker),map.setView(t),render_template(zone_name_template,{zone:n.CPD_Zone.toLowerCase(),zone_upper:n.CPD_Zone}),render_template(card_template,{image:n.CAPT_IMG,name:n.CAPT,email:n.CAPT_EMAIL}),render_template(card_template,{image:n.LT_IMG,name:n.LT,email:n.LT_EMAIL})}else $("#flash").html(flash_message("error","Your address wasn't found in a region. Try another address."))}else $("#flash").html(flash_message("error","No results found for your address."))},error:function(){$("#flash").html(flash_message("error","There was an issue finding where you live. Please try again."))}})})}).addTo(map);